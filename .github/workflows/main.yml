name: CI
on:
  push:
    branches:
      - develop #here we choose to deploy only when a push is detected on the develop branch
jobs:
  check:
    name: Check files
    outputs:
      deploy_admin: ${{ steps.check_files.outputs.deploy_admin }}
      deploy_front: ${{ steps.check_files.outputs.deploy_front }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
      - name: check modified files
        id: check_files
        run: |
          echo "=============== list modified files ==============="
          echo "::set-output name=deploy_admin::false"
          echo "::set-output name=deploy_front::false"

          git diff --name-only HEAD^ HEAD

          echo "========== check paths of modified files =========="
          git diff --name-only HEAD^ HEAD > files.txt
          while IFS= read -r file
          do
            echo $file
            if [[ $file != admin/* ]]; then
              echo "This modified file is not under the admin folder. so we need to deploy front"
              echo "::set-output name=deploy_front::true"
            else
              echo "This modified file is not under the admin folder. so we need to deploy front"
              echo "::set-output name=deploy_admin::true"
            fi
          done < files.txt
  echoOutputs: 
    runs-on: ubuntu-latest
    needs: check
    steps:
      - env:
          OUTPUT1: ${{needs.check.outputs.deploy_front}}
          OUTPUT2: ${{needs.check.outputs.deploy_admin}}
        run: echo "$OUTPUT1 $OUTPUT2"
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1 # Use your bucket region here

    - name: Build static site
      run: npm install && npm run generate

    - name: Deploy static site to S3 bucket
      run: aws s3 sync ./dist/ s3://test-ci-cd-1 --delete
      # --delete flag will remove any file in the s3 that are not on the "thefoldertodeploy" folder
